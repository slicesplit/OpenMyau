package myau.module.modules;

import myau.module.ModuleInfo;
import myau.enums.ModuleCategory;

import myau.event.EventTarget;
import myau.event.types.EventType;
import myau.events.PacketEvent;
import myau.module.Module;
import net.minecraft.client.Minecraft;
import net.minecraft.client.gui.GuiDownloadTerrain;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;

/**
 * InfHealthExploit - Infinite Health Exploit for 1.8.9 Bedwars
 * 
 * Based on portal godmode exploit where cancelling teleport confirmation
 * causes server desync, making player invincible (except to void damage).
 * 
 * The exploit works by:
 * 1. Detecting world transitions (lobby -> match via GuiDownloadTerrain)
 * 2. Cancelling S08PacketPlayerPosLook (teleport confirmation) during transition
 * 3. Server thinks player hasn't spawned yet, so damage packets are ignored
 * 4. Player can move and attack normally, but cannot take damage (except void)
 * 
 * Reference: Portal GodMode exploit from modern Minecraft (1.21+)
 * Adapted for 1.8.9 Bedwars server transitions
 */
@ModuleInfo(category = ModuleCategory.MISC)
public class InfHealthExploit extends Module {
    private static final Minecraft mc = Minecraft.getMinecraft();
    
    private boolean godModeActive = false;
    private boolean worldTransitionDetected = false;
    private long transitionStartTime = 0L;
    private static final long TRANSITION_WINDOW_MS = 3000; // 3 second window to catch teleport
    
    public InfHealthExploit() {
        super("InfHealthExploit", false);
    }

    @Override
    public void onEnabled() {
        godModeActive = false;
        worldTransitionDetected = false;
        transitionStartTime = 0L;
    }

    @Override
    public void onDisabled() {
        godModeActive = false;
        worldTransitionDetected = false;
        transitionStartTime = 0L;
    }

    @EventTarget
    public void onPacket(PacketEvent event) {
        if (!this.isEnabled() || mc.thePlayer == null) {
            return;
        }

        // RECEIVE: Detect world loading (transition from lobby to match)
        if (event.getType() == EventType.RECEIVE) {
            // Detect world transition via download terrain screen
            if (mc.currentScreen instanceof GuiDownloadTerrain) {
                if (!worldTransitionDetected) {
                    worldTransitionDetected = true;
                    transitionStartTime = System.currentTimeMillis();
                    godModeActive = false; // Reset god mode flag
                }
            }
            
            // Intercept teleport packet during transition window
            if (event.getPacket() instanceof S08PacketPlayerPosLook) {
                long currentTime = System.currentTimeMillis();
                
                // Only cancel if within transition window
                if (worldTransitionDetected && 
                    (currentTime - transitionStartTime) <= TRANSITION_WINDOW_MS) {
                    
                    // Cancel the teleport confirmation - this activates god mode!
                    event.setCancelled(true);
                    godModeActive = true;
                    
                    // Reset transition detection
                    worldTransitionDetected = false;
                    transitionStartTime = 0L;
                }
            }
        }
    }
    
    /**
     * Check if god mode is currently active
     */
    public boolean isGodModeActive() {
        return godModeActive;
    }
}
